<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Element Card</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:rgba(15,22,32,.78);
      --panel2:rgba(12,18,26,.58);
      --text:#e7eef7;
      --muted:#9fb0c3;
      --border:rgba(255,255,255,.08);
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --radius:18px;

      --accent:#7aa2ff;
      --good:#a3ff6f;
      --warn:#ffcc66;
      --bad:#ff5c7a;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(122,162,255,.18), transparent 60%),
        radial-gradient(900px 550px at 90% 10%, rgba(76,201,240,.15), transparent 55%),
        radial-gradient(900px 600px at 50% 110%, rgba(163,255,111,.12), transparent 60%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:22px;
    }

    .app{ width:min(1100px, 100%); display:flex; flex-direction:column; gap:14px; }

    header{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:14px 16px;
      background:rgba(15,22,32,.75);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }

    .brand{ display:flex; flex-direction:column; gap:2px; }
    .brand h1{
      font-size:14px;
      letter-spacing:.12em;
      text-transform:uppercase;
      margin:0;
      color:rgba(231,238,247,.92);
    }
    .brand .sub{ font-size:12px; color:var(--muted); margin:0; }

    .rightHeader{ display:flex; gap:10px; align-items:center; }

    .tabs{
      display:flex;
      gap:8px;
      align-items:center;
      padding:6px;
      border:1px solid var(--border);
      background:rgba(12,18,26,.45);
      border-radius:999px;
    }
    .tab{
      border:1px solid transparent;
      background:transparent;
      color:rgba(159,176,195,.95);
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:950;
      letter-spacing:.02em;
    }
    .tab.active{
      color:var(--text);
      border-color: rgba(122,162,255,.35);
      background: rgba(122,162,255,.18);
    }

    .pill{
      display:flex; gap:8px; align-items:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(12,18,26,.45);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background:var(--accent);
      box-shadow:0 0 18px rgba(122,162,255,.35);
    }

    .card{
      border:1px solid var(--border);
      border-radius: 16px;
      background:var(--panel);
      padding:14px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }

    .searchRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .search{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      background:rgba(11,15,20,.70);
    }
    .search input{
      width:100%;
      border:0;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:16px;
      font-weight:950;
      letter-spacing:.02em;
    }
    .search input::placeholder{ color:rgba(159,176,195,.65); font-weight:850; }

    .btn{
      border:1px solid var(--border);
      background:rgba(17,27,39,.65);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:950;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px) }
    .btn.primary{ background:rgba(122,162,255,.22); border-color: rgba(122,162,255,.35); }
    .btn.ghost{ background:rgba(12,18,26,.25); }
    .btn.bad{ background:rgba(255,92,122,.14); border-color: rgba(255,92,122,.28); }

    .hint{
      margin:10px 0 0 0;
      color:rgba(159,176,195,.88);
      font-size:12px;
      line-height:1.35;
    }
    code{ background:rgba(0,0,0,.22); padding:2px 6px; border-radius:8px; border:1px solid var(--border); }

    .layout{
      display:grid;
      grid-template-columns: 1.35fr .65fr;
      gap:12px;
      margin-top:12px;
      align-items:start;
    }
    @media(max-width: 960px){
      .layout{ grid-template-columns: 1fr; }
    }

    .panel2{
      border:1px solid var(--border);
      border-radius: 18px;
      background:var(--panel2);
      padding:14px;
    }

    .badges{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(11,15,20,.55);
      color:var(--muted);
      font-size:12px;
      font-weight:950;
    }

    .hero{ display:flex; gap:14px; align-items:flex-start; }
    .symbolBox{
      width:118px;
      height:118px;
      border-radius:18px;
      border:1px solid var(--border);
      background:rgba(11,15,20,.55);
      display:grid;
      place-items:center;
      position:relative;
      overflow:hidden;
    }
    .symbolBox::after{
      content:"";
      position:absolute;
      inset:-55%;
      background: radial-gradient(circle at 30% 30%, rgba(122,162,255,.22), transparent 55%);
      transform: rotate(12deg);
    }
    .symbol{
      position:relative;
      z-index:1;
      font-size:50px;
      font-weight:1000;
      letter-spacing:.02em;
    }

    .meta{ flex:1; display:flex; flex-direction:column; gap:6px; padding-top:6px; }
    .name{ font-size:26px; font-weight:1000; margin:0; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media(max-width: 560px){
      .grid{ grid-template-columns: 1fr; }
    }

    .kv{
      padding:10px;
      border:1px solid var(--border);
      border-radius:14px;
      background:rgba(11,15,20,.48);
      font-size:13px;
      min-height: 62px;
    }
    .k{
      color:rgba(159,176,195,.85);
      font-weight:900;
      letter-spacing:.02em;
      font-size:12px;
      text-transform:uppercase;
    }
    .v{ color:rgba(231,238,247,.96); font-weight:950; font-size:16px; margin-top:4px; }
    .v.small{ font-size:13px; font-weight:900; color:rgba(231,238,247,.92); line-height:1.35; }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px; }

    details{
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:16px;
      background:rgba(11,15,20,.26);
      overflow:hidden;
    }
    summary{
      cursor:pointer;
      user-select:none;
      padding:12px 12px;
      font-weight:1000;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size:12px;
      color:rgba(231,238,247,.92);
      outline:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    summary .sub{
      font-weight:900;
      letter-spacing:0;
      text-transform:none;
      color:rgba(159,176,195,.9);
      font-size:12px;
    }
    .advBody{
      padding:12px;
      border-top:1px solid var(--border);
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media(max-width: 740px){
      .advBody{ grid-template-columns: 1fr; }
    }

    .sideTitle{
      font-size:12px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color:rgba(231,238,247,.90);
      margin:0 0 10px 0;
      font-weight:1000;
    }

    .list{ display:flex; flex-direction:column; gap:8px; }
    .list button{
      width:100%;
      text-align:left;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(11,15,20,.48);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
    }
    .list button:hover{
      border-color: rgba(122,162,255,.35);
      background: rgba(122,162,255,.10);
    }

    .empty{
      margin-top:14px;
      color:rgba(159,176,195,.88);
      font-size:13px;
      line-height:1.35;
    }

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:18px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(12,18,26,.85);
      color:var(--text);
      font-size:12px;
      box-shadow:var(--shadow);
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-2px); }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .mono sup{ font-size:.8em; }

    /* Ionization chart */
    .chartBox{
      border:1px solid var(--border);
      border-radius:14px;
      background:rgba(11,15,20,.48);
      padding:10px;
    }
    canvas{ display:block; width:100%; height:160px; }

    /* Views */
    #viewCard{ display:block; }
    #viewTable{ display:none; }

    /* Periodic table */
    .ptGrid{
      display:grid;
      grid-template-columns: repeat(18, minmax(42px, 1fr));
      gap:8px;
      margin-top:12px;
    }
    @media(max-width: 980px){
      .ptGrid{ grid-template-columns: repeat(9, minmax(42px, 1fr)); }
    }

    .ptCell{
      border:1px solid var(--border);
      background:rgba(11,15,20,.48);
      border-radius:14px;
      padding:8px;
      min-height:68px;
      cursor:pointer;
      position:relative;
      overflow:hidden;
      user-select:none;
    }
    .ptCell:hover{
      border-color: rgba(122,162,255,.35);
      background: rgba(122,162,255,.10);
    }
    .ptCell.placeholder{
      opacity:.18;
      cursor:default;
    }
    .ptCell .n{
      position:absolute;
      top:7px; left:8px;
      font-size:11px;
      color:rgba(159,176,195,.9);
      font-weight:900;
    }
    .ptCell .s{
      margin-top:12px;
      font-size:18px;
      font-weight:1000;
      letter-spacing:.02em;
    }
    .ptCell .nm{
      font-size:10px;
      color:rgba(159,176,195,.9);
      margin-top:4px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .ptCell .p{
      position:absolute;
      bottom:7px; right:8px;
      font-size:10px;
      color:rgba(159,176,195,.75);
      font-weight:900;
    }

    .fblockWrap{
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:18px;
      background:rgba(11,15,20,.22);
      padding:12px;
    }
    .fblockTitle{
      font-size:12px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color:rgba(231,238,247,.90);
      font-weight:1000;
      margin:2px 0 10px 0;
    }
    .fGrid{
      display:grid;
      grid-template-columns: repeat(15, minmax(42px, 1fr));
      gap:8px;
    }
    @media(max-width: 980px){
      .fGrid{ grid-template-columns: repeat(5, minmax(42px, 1fr)); }
    }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="brand">
        <h1>Element Card</h1>
        <p class="sub">one search bar • nerd panel • full table</p>
      </div>

      <div class="rightHeader">
        <div class="tabs">
          <button class="tab active" id="tabCard">Card</button>
          <button class="tab" id="tabTable">Periodic Table</button>
        </div>
        <div class="pill">
          <span class="dot" id="dsDot"></span>
          <span id="dsText">Loading…</span>
        </div>
      </div>
    </header>

    <!-- CARD VIEW -->
    <section class="card" id="viewCard">
      <div class="searchRow">
        <div class="search">
          <span style="color:rgba(159,176,195,.85);font-weight:1000;">⌕</span>
          <input id="q" type="text" autocomplete="off"
                 placeholder="Name, Symbol, Atomic #, or Mass (e.g. 12.011)" />
        </div>
        <button class="btn primary" id="btnSearch">Search</button>
        <button class="btn ghost" id="btnRandom">Random</button>
        <button class="btn bad" id="btnClear">Clear</button>
      </div>

      <p class="hint">
        Input logic: <b>decimal</b> → mass • <b>1–3 digits</b> → atomic # • <b>1–3 letters</b> → symbol • otherwise → name.
        Uses <code>elements.json</code>.
      </p>

      <div class="layout" id="layout" style="display:none;">
        <!-- MAIN CARD -->
        <div class="panel2">
          <div class="badges">
            <span class="badge"><span class="dot" id="catDot"></span><span id="catText">Category</span></span>
            <span class="badge">Group: <span class="v" id="groupText" style="font-size:12px;">—</span></span>
            <span class="badge">Period: <span class="v" id="periodText" style="font-size:12px;">—</span></span>
            <span class="badge">Block: <span class="v" id="blockText" style="font-size:12px;">—</span></span>
          </div>

          <div class="hero">
            <div class="symbolBox"><div class="symbol" id="sym">—</div></div>
            <div class="meta">
              <p class="name" id="name">—</p>

              <div class="grid">
                <div class="kv"><div class="k">Atomic #</div><div class="v" id="anum">—</div></div>
                <div class="kv"><div class="k">Atomic mass</div><div class="v" id="amass">—</div></div>
                <div class="kv"><div class="k">Natural state (STP)</div><div class="v" id="stateText">—</div></div>
                <div class="kv"><div class="k">Melting point (°C)</div><div class="v" id="mpText">—</div></div>
                <div class="kv"><div class="k">Boiling point (°C)</div><div class="v" id="bpText">—</div></div>
                <div class="kv"><div class="k">Electronegativity (Pauling)</div><div class="v" id="enText">—</div></div>
              </div>

              <div class="row">
                <button class="btn ghost" id="btnCopySymbol">Copy Symbol</button>
                <button class="btn ghost" id="btnCopyCard">Copy Card</button>
                <button class="btn ghost" id="btnOpenInTable">Show in Table</button>
              </div>

              <details id="detailsAdvanced">
                <summary>
                  <span>Advanced</span>
                  <span class="sub">superscripts • shells • ionization chart</span>
                </summary>

                <div class="advBody">
                  <div class="kv">
                    <div class="k">Electron configuration</div>
                    <div class="v small mono" id="ecText">—</div>
                  </div>

                  <div class="kv">
                    <div class="k">Shells</div>
                    <div class="v small mono" id="shellsText">—</div>
                  </div>

                  <div class="kv" style="grid-column:1/-1;">
                    <div class="k">Ionization energies (kJ/mol)</div>
                    <div class="chartBox">
                      <canvas id="ieCanvas"></canvas>
                      <div class="v small mono" id="ieList" style="margin-top:8px;">—</div>
                    </div>
                  </div>

                  <div class="kv">
                    <div class="k">Electron affinity (kJ/mol)</div>
                    <div class="v" id="eaText">—</div>
                  </div>

                  <div class="kv">
                    <div class="k">Density (g/cm³)</div>
                    <div class="v" id="densityText">—</div>
                  </div>

                  <div class="kv">
                    <div class="k">Molar heat (J/mol·K)</div>
                    <div class="v" id="molarHeatText">—</div>
                  </div>

                  <div class="kv" style="grid-column:1/-1;">
                    <div class="k">Summary</div>
                    <div class="v small" id="summaryText">—</div>
                  </div>

                  <div class="kv">
                    <div class="k">Discovered by</div>
                    <div class="v small" id="discoveredByText">—</div>
                  </div>

                  <div class="kv">
                    <div class="k">Source</div>
                    <div class="v small mono" id="sourceText">—</div>
                  </div>
                </div>
              </details>
            </div>
          </div>
        </div>

        <!-- MATCHES -->
        <div class="panel2">
          <p class="sideTitle">Matches</p>
          <div id="matchHint" class="empty">If multiple results fit (name partials), pick one.</div>
          <div class="list" id="matchList"></div>
        </div>
      </div>

      <div id="emptyState" class="empty">Type something and hit <b>Search</b>.</div>
    </section>

    <!-- TABLE VIEW -->
    <section class="card" id="viewTable">
      <div class="searchRow">
        <div class="search">
          <span style="color:rgba(159,176,195,.85);font-weight:1000;">⌕</span>
          <input id="ptFilter" type="text" autocomplete="off"
                 placeholder="Filter by name/symbol/category (optional)" />
        </div>
        <button class="btn ghost" id="btnPtClear">Clear</button>
        <button class="btn primary" id="btnPtOpen">Open selected in Card</button>
      </div>

      <p class="hint">
        Main grid uses <b>group + period</b>. Lanthanides and actinides are always shown in the f-block rows.
      </p>

      <div class="ptGrid" id="ptGrid"></div>

      <div class="fblockWrap">
        <div class="fblockTitle">Lanthanides (57–71)</div>
        <div class="fGrid" id="ptLanth"></div>

        <div class="fblockTitle" style="margin-top:10px;">Actinides (89–103)</div>
        <div class="fGrid" id="ptAct"></div>
      </div>

      <div class="empty" id="ptSelected" style="margin-top:10px;">Selected: —</div>
    </section>
  </div>

  <div class="toast" id="toast"></div>

<script>
  const $ = (s)=>document.querySelector(s);
  const toastEl = $("#toast");
  const tabCard = $("#tabCard");
  const tabTable = $("#tabTable");
  const viewCard = $("#viewCard");
  const viewTable = $("#viewTable");

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(()=>toastEl.classList.remove("show"), 1500);
  }

  function normalize(s){ return String(s ?? "").trim().toLowerCase(); }
  function asNum(v){
    const n = (typeof v === "number") ? v : Number(v);
    return Number.isFinite(n) ? n : null;
  }
  function fmtNum(n, digits=3){
    if(n == null || !Number.isFinite(n)) return "—";
    const s = String(n);
    if(s.length <= 8) return s;
    return n.toFixed(digits);
  }

  function setDatasetStatus(ok, msg){
    $("#dsDot").style.background = ok ? "var(--good)" : "var(--warn)";
    $("#dsText").innerHTML = msg;
  }

  // Returns: [dotColor, tintRGBA]
  function categoryPalette(catRaw){
    const cat = normalize(catRaw);

    if(cat.includes("noble"))           return ["var(--accent)", "rgba(122,162,255,0.20)"];
    if(cat.includes("halogen"))         return ["var(--warn)",   "rgba(255,204,102,0.18)"];
    if(cat.includes("alkali"))          return ["var(--bad)",    "rgba(255,92,122,0.18)"];
    if(cat.includes("alkaline"))        return ["var(--good)",   "rgba(163,255,111,0.16)"];

    if(cat.includes("lanthan"))         return ["rgba(180,140,255,0.95)", "rgba(180,140,255,0.18)"];
    if(cat.includes("actin"))           return ["rgba(255,140,180,0.95)", "rgba(255,140,180,0.16)"];
    if(cat.includes("transition"))      return ["rgba(255,204,102,0.95)", "rgba(255,204,102,0.13)"];
    if(cat.includes("post-transition")) return ["rgba(159,176,195,0.95)", "rgba(159,176,195,0.13)"];

    if(cat.includes("metalloid"))       return ["rgba(163,255,111,0.90)", "rgba(163,255,111,0.12)"];
    if(cat.includes("nonmetal"))        return ["rgba(122,162,255,0.90)", "rgba(122,162,255,0.12)"];

    if(cat.includes("metal"))           return ["rgba(200,210,225,0.95)", "rgba(200,210,225,0.10)"];
    return ["rgba(159,176,195,0.95)", "rgba(159,176,195,0.10)"];
  }

  // "1s2 2s2 2p6" => "1s<sup>2</sup> 2s<sup>2</sup> 2p<sup>6</sup>"
  function toSuperscriptHTML(config){
    const s = String(config ?? "").trim();
    if(!s) return "—";
    return s
      .replace(/([0-9]+[spdf])\s*([0-9]+)/gi, (_, orb, exp) => `${orb}<sup>${exp}</sup>`)
      .replace(/\s+/g, " ")
      .trim();
  }

  // Dataset
  let ELEMENTS = [];
  let lastRendered = null;

  // Periodic table selection
  let selectedFromTable = null;

  async function loadDataset(){
    try{
      const res = await fetch("./elements.json", { cache:"no-store" });
      if(!res.ok) throw new Error("no elements.json");
      const data = await res.json();
      if(!Array.isArray(data) || data.length < 100) throw new Error("dataset too small");

      ELEMENTS = data
        .filter(e => e && e.symbol && e.name && (typeof e.number === "number" || /^\d+$/.test(String(e.number))))
        .map(e => ({
          number: asNum(e.number),
          symbol: String(e.symbol),
          name: String(e.name),

          atomic_mass: asNum(e.atomic_mass ?? e.atomicMass ?? e.mass),
          group: asNum(e.group),
          period: asNum(e.period),
          category: String(e.category ?? e.type ?? "unknown"),
          block: String(e.block ?? "—"),

          state_stp: String(e.state_stp ?? e.state ?? e.phase ?? "unknown"),
          melting_point_c: asNum(e.melting_point_c ?? e.melting_c ?? e.meltingPointC),
          boiling_point_c: asNum(e.boiling_point_c ?? e.boiling_c ?? e.boilingPointC),

          electronegativity_pauling: asNum(e.electronegativity_pauling ?? e.electronegativity),
          electron_affinity_kj_mol: asNum(e.electron_affinity_kj_mol ?? e.electron_affinity),
          ionization_energies_kj_mol: Array.isArray(e.ionization_energies_kj_mol ?? e.ionization_energies)
            ? (e.ionization_energies_kj_mol ?? e.ionization_energies).map(asNum).filter(x=>x!=null)
            : [],

          electron_configuration: String(e.electron_configuration ?? ""),
          electron_configuration_semantic: String(e.electron_configuration_semantic ?? ""),

          shells: Array.isArray(e.shells) ? e.shells : [],
          density_g_cm3: asNum(e.density_g_cm3 ?? e.density),
          molar_heat_j_mol_k: asNum(e.molar_heat_j_mol_k ?? e.molar_heat),

          summary: String(e.summary ?? "—"),
          discovered_by: String(e.discovered_by ?? "—"),
          source: String(e.source ?? "")
        }))
        .filter(e => e.number != null)
        .sort((a,b)=>a.number-b.number);

      setDatasetStatus(true, `Dataset: <b>${ELEMENTS.length}</b> elements`);
    }catch(err){
      setDatasetStatus(false, `Missing <code>elements.json</code> or invalid dataset`);
      ELEMENTS = [];
      console.error(err);
    }
  }

  function parseQuery(raw){
    const q = raw.trim();
    if(!q) return { kind:"empty" };

    if(q.includes(".")){
      const mass = Number(q);
      if(Number.isFinite(mass)) return { kind:"mass", mass };
      return { kind:"bad", reason:"Mass must be a number like 12.011" };
    }

    if(/^\d{1,3}$/.test(q)) return { kind:"number", number: Number(q) };
    if(/^[a-zA-Z]{1,3}$/.test(q)) return { kind:"symbol", symbol: q };
    return { kind:"name", name: q };
  }

  function findByNumber(n){ return ELEMENTS.filter(e => e.number === n); }
  function findBySymbol(sym){
    const s = normalize(sym);
    return ELEMENTS.filter(e => normalize(e.symbol) === s);
  }
  function findByName(name){
    const n = normalize(name);
    const exact = ELEMENTS.filter(e => normalize(e.name) === n);
    if(exact.length) return exact;
    const starts = ELEMENTS.filter(e => normalize(e.name).startsWith(n));
    if(starts.length) return starts;
    return ELEMENTS.filter(e => normalize(e.name).includes(n));
  }
  function findByMass(mass){
    const withMass = ELEMENTS.filter(e => e.atomic_mass != null);
    if(!withMass.length) return [];
    let best = null;
    let bestDiff = Infinity;
    for(const e of withMass){
      const d = Math.abs(e.atomic_mass - mass);
      if(d < bestDiff){ bestDiff = d; best = e; }
    }
    // modest tolerance so it doesn't lie
    if(best && bestDiff <= 0.15) return [best];
    return [];
  }

  function clearCardUI(){
    $("#q").value = "";
    $("#layout").style.display = "none";
    $("#emptyState").style.display = "block";
    $("#emptyState").textContent = "Type something and hit Search.";
    $("#matchList").innerHTML = "";
    $("#matchHint").textContent = "If multiple results fit (name partials), pick one.";
  }

  function setText(sel, val){
    const el = $(sel);
    el.textContent = (val === null || val === undefined || val === "" ? "—" : String(val));
  }

  function renderIonizationChart(canvas, energies){
    const ctx = canvas.getContext("2d");
    const dpr = Math.max(1, window.devicePixelRatio || 1);

    // Fit to CSS size
    const cssW = canvas.clientWidth;
    const cssH = canvas.clientHeight;
    canvas.width = Math.floor(cssW * dpr);
    canvas.height = Math.floor(cssH * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

    ctx.clearRect(0,0,cssW,cssH);

    if(!Array.isArray(energies) || energies.length === 0){
      ctx.globalAlpha = 0.85;
      ctx.font = "12px ui-monospace, Menlo, Consolas, monospace";
      ctx.fillStyle = "rgba(159,176,195,.95)";
      ctx.fillText("No ionization energy data available.", 10, 24);
      return;
    }

    const vals = energies.slice(0, 10); // readable default
    const maxV = Math.max(...vals);
    const minV = Math.min(...vals);

    const padL = 34, padR = 10, padT = 10, padB = 22;
    const w = cssW - padL - padR;
    const h = cssH - padT - padB;

    // Grid
    ctx.strokeStyle = "rgba(255,255,255,.10)";
    ctx.lineWidth = 1;
    for(let i=0;i<=4;i++){
      const y = padT + (h * i/4);
      ctx.beginPath();
      ctx.moveTo(padL, y);
      ctx.lineTo(padL + w, y);
      ctx.stroke();
    }

    ctx.fillStyle = "rgba(159,176,195,.95)";
    ctx.font = "11px ui-monospace, Menlo, Consolas, monospace";
    ctx.fillText("kJ/mol", 6, 14);

    const xStep = (vals.length === 1) ? 0 : (w / (vals.length - 1));
    const yFor = (v) => {
      const t = (maxV === minV) ? 0.5 : ((maxV - v) / (maxV - minV));
      return padT + t * h;
    };

    // Line
    ctx.strokeStyle = "rgba(122,162,255,.85)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    vals.forEach((v,i)=>{
      const x = padL + i*xStep;
      const y = yFor(v);
      if(i===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    });
    ctx.stroke();

    // Points + labels
    vals.forEach((v,i)=>{
      const x = padL + i*xStep;
      const y = yFor(v);

      ctx.fillStyle = "rgba(231,238,247,.95)";
      ctx.beginPath();
      ctx.arc(x,y,3,0,Math.PI*2);
      ctx.fill();

      ctx.fillStyle = "rgba(159,176,195,.90)";
      ctx.fillText(`IE${i+1}`, x-10, padT + h + 16);
    });
  }

  function renderElement(e){
    lastRendered = e;

    setText("#sym", e.symbol ?? "—");
    setText("#name", e.name ?? "—");
    setText("#anum", e.number ?? "—");
    setText("#amass", fmtNum(e.atomic_mass, 6));

    const cat = e.category ?? "unknown";
    $("#catText").textContent = cat;
    const [dot] = categoryPalette(cat);
    $("#catDot").style.background = dot;

    setText("#groupText", (e.group != null) ? e.group : "—");
    setText("#periodText", (e.period != null) ? e.period : "—");
    setText("#blockText", e.block ?? "—");

    setText("#stateText", e.state_stp ?? "unknown");
    setText("#mpText", (e.melting_point_c != null) ? fmtNum(e.melting_point_c, 2) : "—");
    setText("#bpText", (e.boiling_point_c != null) ? fmtNum(e.boiling_point_c, 2) : "—");
    setText("#enText", (e.electronegativity_pauling != null) ? fmtNum(e.electronegativity_pauling, 2) : "—");

    // Superscript config
    const conf = (e.electron_configuration_semantic || e.electron_configuration || "").trim();
    $("#ecText").innerHTML = conf ? toSuperscriptHTML(conf) : "—";

    $("#shellsText").textContent = Array.isArray(e.shells) && e.shells.length ? `[${e.shells.join(", ")}]` : "—";

    const ies = Array.isArray(e.ionization_energies_kj_mol) ? e.ionization_energies_kj_mol : [];
    $("#ieList").textContent = ies.length ? ies.slice(0,10).map(v => fmtNum(v,2)).join(", ") + (ies.length>10 ? " …" : "") : "—";
    renderIonizationChart($("#ieCanvas"), ies);

    setText("#eaText", (e.electron_affinity_kj_mol != null) ? fmtNum(e.electron_affinity_kj_mol, 2) : "—");
    setText("#densityText", (e.density_g_cm3 != null) ? fmtNum(e.density_g_cm3, 4) : "—");
    setText("#molarHeatText", (e.molar_heat_j_mol_k != null) ? fmtNum(e.molar_heat_j_mol_k, 4) : "—");

    setText("#summaryText", e.summary ?? "—");
    setText("#discoveredByText", e.discovered_by ?? "—");
    setText("#sourceText", e.source ?? "—");

    $("#btnCopySymbol").onclick = async ()=>{
      try{ await navigator.clipboard.writeText(e.symbol); toast("Copied symbol"); }
      catch(_){ toast("Clipboard blocked"); }
    };

    $("#btnCopyCard").onclick = async ()=>{
      const card =
`# ${e.name} (${e.symbol})
Atomic #: ${e.number}
Atomic mass: ${fmtNum(e.atomic_mass, 6)}
Group: ${e.group ?? "—"}  Period: ${e.period ?? "—"}  Block: ${e.block ?? "—"}
Category: ${cat}
State (STP): ${e.state_stp ?? "unknown"}
Melting point (°C): ${e.melting_point_c ?? "—"}
Boiling point (°C): ${e.boiling_point_c ?? "—"}

Electron config: ${conf || "—"}
Shells: ${Array.isArray(e.shells)&&e.shells.length ? e.shells.join(", ") : "—"}
Electronegativity (Pauling): ${e.electronegativity_pauling ?? "—"}
Electron affinity (kJ/mol): ${e.electron_affinity_kj_mol ?? "—"}
Ionization energies (kJ/mol): ${ies.length ? ies.join(", ") : "—"}`;
      try{ await navigator.clipboard.writeText(card); toast("Copied card"); }
      catch(_){ toast("Clipboard blocked"); }
    };

    $("#btnOpenInTable").onclick = ()=>{
      switchView("table");
      selectInTable(e.number);
    };
  }

  function showResults(matches){
    $("#layout").style.display = "grid";
    $("#emptyState").style.display = "none";

    const list = $("#matchList");
    list.innerHTML = "";

    if(matches.length > 1){
      $("#matchHint").textContent = `Found ${matches.length} matches. Click one.`;
      matches.slice(0, 14).forEach(e=>{
        const b = document.createElement("button");
        b.textContent = `${e.number} • ${e.symbol} • ${e.name}`;
        b.addEventListener("click", ()=>renderElement(e));
        list.appendChild(b);
      });
    }else{
      $("#matchHint").textContent = "Single match.";
    }

    renderElement(matches[0]);
  }

  function doSearch(){
    if(!ELEMENTS.length){
      toast("Dataset not loaded");
      return;
    }

    const raw = $("#q").value;
    const parsed = parseQuery(raw);

    if(parsed.kind === "empty"){ clearCardUI(); return; }
    if(parsed.kind === "bad"){ toast(parsed.reason); return; }

    let matches = [];
    if(parsed.kind === "mass") matches = findByMass(parsed.mass);
    if(parsed.kind === "number") matches = findByNumber(parsed.number);
    if(parsed.kind === "symbol") matches = findBySymbol(parsed.symbol);
    if(parsed.kind === "name") matches = findByName(parsed.name);

    if(!matches.length){
      $("#layout").style.display = "none";
      $("#emptyState").style.display = "block";
      $("#emptyState").textContent = "No match. Try a different query.";
      return;
    }
    showResults(matches);
  }

  function randomElement(){
    if(!ELEMENTS.length) return;
    const e = ELEMENTS[Math.floor(Math.random()*ELEMENTS.length)];
    $("#q").value = e.symbol;
    doSearch();
  }

  // ===== Periodic Table =====

  function makeCell(e){
    const cell = document.createElement("div");
    cell.className = "ptCell";

    const [_, tint] = categoryPalette(e.category);
    cell.style.background =
      `radial-gradient(140px 60px at 20% 10%, ${tint}, rgba(11,15,20,.48) 60%), rgba(11,15,20,.48)`;

    cell.dataset.number = String(e.number);

    cell.innerHTML = `
      <div class="n">${e.number}</div>
      <div class="s">${e.symbol}</div>
      <div class="nm">${e.name}</div>
      <div class="p">${(e.period?`P${e.period}`:"")}${(e.group?` G${e.group}`:"")}</div>
    `;

    cell.addEventListener("click", ()=>{
      selectedFromTable = e;
      setSelectedOutline(cell);
      $("#ptSelected").textContent = `Selected: ${e.number} • ${e.symbol} • ${e.name}`;
      toast(`Selected ${e.name}`);
    });

    return cell;
  }

  function setSelectedOutline(cell){
    document.querySelectorAll(".ptCell").forEach(ch => ch.style.outline = "none");
    cell.style.outline = "2px solid rgba(122,162,255,.55)";
  }

  function buildPeriodicTable(){
    const grid = $("#ptGrid");
    const lanth = $("#ptLanth");
    const act = $("#ptAct");

    grid.innerHTML = "";
    lanth.innerHTML = "";
    act.innerHTML = "";

    const filter = normalize($("#ptFilter").value);

    // (group,period) map for main 18×7 grid
    const byPos = new Map();
    for(const e of ELEMENTS){
      if(e.group != null && e.period != null){
        byPos.set(`${e.group}:${e.period}`, e);
      }
    }

    // main grid
    for(let p=1; p<=7; p++){
      for(let g=1; g<=18; g++){
        const e = byPos.get(`${g}:${p}`);
        if(e){
          const cell = makeCell(e);
          if(filter){
            const txt = normalize(`${e.number} ${e.symbol} ${e.name} ${e.category}`);
            if(!txt.includes(filter)) cell.style.display = "none";
          }
          grid.appendChild(cell);
        }else{
          const ph = document.createElement("div");
          ph.className = "ptCell placeholder";
          ph.innerHTML = `<div class="p">P${p} G${g}</div>`;
          if(filter) ph.style.display = "none";
          grid.appendChild(ph);
        }
      }
    }

    // f-block rows ALWAYS by atomic number
    const lanthElems = ELEMENTS.filter(e => e.number >= 57 && e.number <= 71);
    const actElems   = ELEMENTS.filter(e => e.number >= 89 && e.number <= 103);

    for(const e of lanthElems){
      const cell = makeCell(e);
      if(filter){
        const txt = normalize(`${e.number} ${e.symbol} ${e.name} ${e.category}`);
        if(!txt.includes(filter)) cell.style.display = "none";
      }
      lanth.appendChild(cell);
    }
    for(const e of actElems){
      const cell = makeCell(e);
      if(filter){
        const txt = normalize(`${e.number} ${e.symbol} ${e.name} ${e.category}`);
        if(!txt.includes(filter)) cell.style.display = "none";
      }
      act.appendChild(cell);
    }

    // If we already have a selected element, keep it outlined after rebuild
    if(selectedFromTable){
      const sel = document.querySelector(`.ptCell[data-number="${selectedFromTable.number}"]`);
      if(sel) setSelectedOutline(sel);
    }
  }

  function selectInTable(atomicNumber){
    selectedFromTable = ELEMENTS.find(e => e.number === atomicNumber) || null;
    if(!selectedFromTable) return;

    buildPeriodicTable(); // rebuild so selection exists

    const sel = document.querySelector(`.ptCell[data-number="${atomicNumber}"]`);
    if(sel){
      setSelectedOutline(sel);
      $("#ptSelected").textContent = `Selected: ${selectedFromTable.number} • ${selectedFromTable.symbol} • ${selectedFromTable.name}`;
      // Scroll into view (gentle)
      sel.scrollIntoView({ block:"center", inline:"center", behavior:"smooth" });
    }
  }

  // ===== View switching =====
  function switchView(which){
    if(which === "card"){
      tabCard.classList.add("active");
      tabTable.classList.remove("active");
      viewCard.style.display = "block";
      viewTable.style.display = "none";
      setTimeout(()=>$("#q").focus(), 60);
    }else{
      tabTable.classList.add("active");
      tabCard.classList.remove("active");
      viewCard.style.display = "none";
      viewTable.style.display = "block";
      buildPeriodicTable();
      setTimeout(()=>$("#ptFilter").focus(), 60);
    }
  }

  // ===== Wire UI =====
  $("#btnSearch").addEventListener("click", doSearch);
  $("#btnRandom").addEventListener("click", randomElement);
  $("#btnClear").addEventListener("click", clearCardUI);
  $("#q").addEventListener("keydown", (e)=>{ if(e.key === "Enter") doSearch(); });

  tabCard.addEventListener("click", ()=>switchView("card"));
  tabTable.addEventListener("click", ()=>switchView("table"));

  $("#ptFilter").addEventListener("input", ()=>buildPeriodicTable());
  $("#btnPtClear").addEventListener("click", ()=>{
    $("#ptFilter").value = "";
    buildPeriodicTable();
  });
  $("#btnPtOpen").addEventListener("click", ()=>{
    if(!selectedFromTable){
      toast("Select an element first");
      return;
    }
    switchView("card");
    $("#q").value = selectedFromTable.symbol;
    doSearch();
  });

  // Init
  (async ()=>{
    await loadDataset();
    switchView("card");
    setTimeout(()=>$("#q").focus(), 120);
  })();
</script>
</body>
</html>
